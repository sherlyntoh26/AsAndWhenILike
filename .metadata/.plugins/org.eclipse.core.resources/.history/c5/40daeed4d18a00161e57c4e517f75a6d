package project;

import java.math.BigDecimal;

import com.datastax.driver.core.PreparedStatement;
import com.datastax.driver.core.ResultSet;
import com.datastax.driver.core.Row;
import com.datastax.driver.core.Session;

public class PaymentTransaction {
	// private attributes
	private Session session;
	private PreparedStatement selectWarehouseStmt;
	private PreparedStatement updateWarehouseStmt;
	private PreparedStatement selectCustomerStmt;
	private PreparedStatement updateCustomerStmt;

	public PaymentTransaction() {

	}

	public PaymentTransaction(Connection connection) {
		session = connection.getSession();
		selectWarehouseStmt = session.prepare("SELECT wdi_w_ytd, ? FROM warehouseDistrictInfo WHERE wdi_w_id = ?;");
		updateWarehouseStmt = session.prepare("UPDATE warehouseDistrictInfo SET wdi_w_ytd = ?, ? = ? WHERE wdi_w_id = ?;");
		selectCustomerStmt = session.prepare("SELECT c_balance, c_ytd_payment, c_payment_cnt FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;");
		updateCustomerStmt = session.prepare("UPDATE customer SET c_balence = ?, c_ytd_payment = ?, c_payment_cnt = ? WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;");
	}

	public void makePayment(int cWID, int cDID, int cID, float payment) {

		String wdi_d_ytd;
		if (cDID == 10) {
			wdi_d_ytd = "wdi_d_ytd_10";
		} else {
			wdi_d_ytd = "wdi_d_ytd_0" + cDID;
		}

		// update warehouseDistrictInfo by increasing wdi_w_ytd and wdi_d_ytd_# by payment
		ResultSet warehouseResult = session.execute(selectWarehouseStmt.bind(wdi_d_ytd, cWID));
		Row warehouseRow = warehouseResult.one();
		float w_ytd = warehouseRow.getDecimal("wdi_w_ytd").floatValue();
		float d_ytd = warehouseRow.getDecimal(wdi_d_ytd).floatValue();
		w_ytd += payment;
		d_ytd += payment;
		session.execute(updateWarehouseStmt.bind(BigDecimal.valueOf(w_ytd), wdi_d_ytd, BigDecimal.valueOf(d_ytd), cWID));
		
		// update customer --> decrease c_balance by payment, increase c_ytd_payment by payment, increase c_payment_cnt by 1
		ResultSet customerResult = session.execute(selectCustomerStmt.bind(cWID, cDID, cID));
		Row customerRow = customerResult.one();
		float c_balance = customerRow.getDecimal("c_balance").floatValue();
		float c_ytd_payment = customerRow.getFloat("c_ytd_payment");
		
	}

	// for payment transaction running alone.
	// debuggin use
	public static void main(String[] args) {
		// TODO Auto-generated method stub
		Connection connection = new Connection();
		connection.connect("127.0.0.1", "project");
		PaymentTransaction payment = new PaymentTransaction(connection);

		payment.makePayment(1, 1, 331, 1.02f);
	}

}
