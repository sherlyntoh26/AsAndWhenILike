package project;

import java.util.List;

import com.datastax.driver.core.PreparedStatement;
import com.datastax.driver.core.ResultSet;
import com.datastax.driver.core.Row;
import com.datastax.driver.core.Session;

public class PopularItemTransaction {
	private Session session;
	private PreparedStatement selectWarehouseStmt;
	private PreparedStatement selectOrdersStmt;
	private PreparedStatement selectCustomerStmt;
	
	public PopularItemTransaction(){
		
	}
	
	public PopularItemTransaction(Connection connection){
		this.session = connection.getSession();
		selectWarehouseStmt = session.prepare("SELECT ? FROM warehouseDistrictInfo WHERE wdi_w_id = ?;");
		selectOrdersStmt = session.prepare("SELECT o_id, o_entry_d, o_c_id FROM orders WHERE o_w_id = ? AND o_d_id = ? AND o_id >= ?;");
		selectCustomerStmt = session.prepare("SELECT c_first, c_middle, c_last FROM customer WHERE c_w_id = ? AND c_d_id = ? AND c_id = ?;");
	}
	
	public void getPopularItem(int wID, int dID, int noOfLastOrders){
		
		System.out.println(String.format("District Identifier: (%d, %d)", wID, dID));
		System.out.println(String.format("Number of last orders to be examined: %d", noOfLastOrders));
		
		String nextID;
		if(dID == 10){
			nextID = "wdi_d_next_o_id_10";
		}else{
			nextID = "wdi_d_next_o_id_0" + dID;
		}
		
		ResultSet warehouseResult = session.execute(selectWarehouseStmt.bind(nextID, wID));
		int nextOID = warehouseResult.one().getInt(nextID);
		
		ResultSet ordersResult = session.execute(selectOrdersStmt.bind(wID, dID, nextOID - noOfLastOrders));
		List<Row> ordersRow = ordersResult.all();
		
		for(int i=0; i<ordersRow.size(); i++){
			Row currentRow = ordersRow.get(i);
			ResultSet customerResult = session.execute(selectCustomerStmt.bind(wID, dID, currentRow.getInt("o_c_id")));
		}
	}

}
